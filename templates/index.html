<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8">
  <title>Lavagna Idee</title>
  <script>
    let currentUser = null;

    // Registrazione
    async function register() {
      const username = document.getElementById("reg-username").value;
      const isAdmin = document.getElementById("reg-admin").checked;

      const res = await fetch("/register", {
        method: "POST",
        headers: {"Content-Type": "application/json"},
        body: JSON.stringify({username, is_admin: isAdmin})
      });
      const data = await res.json();
      if(data.status === "ok") {
        currentUser = data.user;
        alert("Registrazione completata!");
        updateUI();
      } else {
        alert(data.message);
      }
    }

    // Login
    async function login() {
      const username = document.getElementById("login-username").value;
      const res = await fetch("/login", {
        method: "POST",
        headers: {"Content-Type": "application/json"},
        body: JSON.stringify({username})
      });
      const data = await res.json();
      if(data.status === "ok") {
        currentUser = data.user;
        alert("Login effettuato!");
        updateUI();
      } else {
        alert(data.message);
      }
    }

    // Logout
    async function logout() {
      await fetch("/logout", {method: "POST"});
      currentUser = null;
      updateUI();
    }

    // Aggiungi idea
    async function addIdea() {
      const content = document.getElementById("idea-content").value;
      const res = await fetch("/idea", {
        method: "POST",
        headers: {"Content-Type": "application/json"},
        body: JSON.stringify({content})
      });
      const data = await res.json();
      if(data.status === "ok") {
        document.getElementById("idea-content").value = "";
        listIdeas();
      } else {
        alert(data.message);
      }
    }

    // Lista idee
    async function listIdeas() {
      const res = await fetch("/ideas");
      const data = await res.json();
      const container = document.getElementById("ideas-list");
      container.innerHTML = "";
      data.ideas.forEach(i => {
        const div = document.createElement("div");
        div.textContent = `${i.username}: ${i.content}`;
        container.appendChild(div);
      });
    }

    // Reset lavagna (solo admin)
    async function resetLavagna() {
      if(!confirm("Sei sicuro di voler resettare la lavagna?")) return;
      const res = await fetch("/reset", {method: "POST"});
      const data = await res.json();
      alert(data.message);
      listIdeas();
    }

    // Aggiorna UI
    function updateUI() {
      document.getElementById("user-info").textContent = currentUser ? `Loggato come: ${currentUser.username} ${currentUser.is_admin ? "(Admin)" : ""}` : "Non loggato";
      document.getElementById("login-section").style.display = currentUser ? "none" : "block";
      document.getElementById("register-section").style.display = currentUser ? "none" : "block";
      document.getElementById("idea-section").style.display = currentUser ? "block" : "none";
      document.getElementById("logout-btn").style.display = currentUser ? "block" : "none";
      document.getElementById("reset-btn").style.display = currentUser && currentUser.is_admin ? "block" : "none";
      listIdeas();
    }

    window.onload = updateUI;
  </script>
</head>
<body>
  <h1>Lavagna Idee</h1>
  <div id="user-info"></div>

  <!-- Registrazione -->
  <div id="register-section">
    <h3>Registrazione</h3>
    <input type="text" id="reg-username" placeholder="Username">
    <label><input type="checkbox" id="reg-admin"> Admin</label>
    <button onclick="register()">Registrati</button>
  </div>

  <!-- Login -->
  <div id="login-section">
    <h3>Login</h3>
    <input type="text" id="login-username" placeholder="Username">
    <button onclick="login()">Login</button>
  </div>

  <!-- Aggiungi idea -->
  <div id="idea-section" style="display:none;">
    <h3>Aggiungi idea</h3>
    <input type="text" id="idea-content" placeholder="Scrivi la tua idea">
    <button onclick="addIdea()">Aggiungi</button>
  </div>

  <!-- Pulsante Reset Lavagna (solo admin) -->
  <button id="reset-btn" style="display:none;" onclick="resetLavagna()">Reset Lavagna (Admin)</button>

  <!-- Logout -->
  <button id="logout-btn" style="display:none;" onclick="logout()">Logout</button>

  <h3>Idee</h3>
  <div id="ideas-list"></div>
</body>
</html>
