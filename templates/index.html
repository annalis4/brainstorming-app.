<!DOCTYPE html>
<html lang="it">
<head>
<meta charset="UTF-8">
<title>Brainstorming Cloud Globale</title>
<style>
body { font-family: Arial; margin:0; padding:0; background:#f9f9f9; overflow:hidden; }
h1 { text-align:center; margin-top:20px; }
#idea-form { text-align:center; margin:20px; }
#idea-input { width:400px; height:80px; padding:10px; font-size:16px; }
#ideas-container { position:relative; width:100vw; height:80vh; overflow:hidden; }
.idea { position:absolute; background:white; padding:6px 12px; border-radius:12px;
       box-shadow:0 4px 8px rgba(0,0,0,0.15); font-weight:bold; word-wrap:break-word;
       max-width:300px; text-align:center; transition:font-size 0.5s ease; }
</style>
</head>
<body>
<h1>Brainstorming Cloud Globale</h1>
<form id="idea-form">
<textarea id="idea-input" placeholder="Scrivi la tua idea senza limiti..."></textarea><br>
<button type="submit">Invia</button>
</form>
<div id="ideas-container"></div>

<script>
const form = document.getElementById("idea-form");
const input = document.getElementById("idea-input");
const container = document.getElementById("ideas-container");

form.addEventListener("submit", async (e) => {
  e.preventDefault();
  const content = input.value.trim();
  if (!content) return;
  const res = await fetch("/idea", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ content })
  });
  const data = await res.json();
  if (data.status === "ok") {
    input.value = "";
    loadIdeas();
  } else {
    alert(data.message);
  }
});

// Controllo collisione
function checkCollision(x, y, width, height, placed){
  return placed.some(p=>{
    return !(x+width < p.x || x > p.x+p.width || y+height < p.y || y > p.y+p.height);
  });
}

async function loadIdeas(){
  const res = await fetch("/ideas");
  const data = await res.json();
  const width = container.clientWidth;
  const height = container.clientHeight;
  const freq = {};
  const placed = [];

  data.ideas.forEach(idea => {
    freq[idea.content] = (freq[idea.content] || 0) + 1;
  });

  const maxFreq = Math.max(...Object.values(freq));
  const minFreq = Math.min(...Object.values(freq));

  for(let idea of data.ideas){
    const phrase = idea.content.trim();
    if (!phrase) continue;
    let div = document.getElementById("idea-" + idea.id);
    if(!div){
      div = document.createElement("div");
      div.className = "idea";
      div.textContent = phrase;
      div.id = "idea-" + idea.id;
      container.appendChild(div);

      // Calcola posizione se non presente
      let x = idea.pos_x, y = idea.pos_y;
      if (x===null || y===null){
        let boxWidth = div.offsetWidth || 100;
        let boxHeight = div.offsetHeight || 40;
        let tries = 0;
        do{
          x = Math.random() * (width - boxWidth - 20);
          y = Math.random() * (height - boxHeight - 20);
          tries++;
          if(tries>2000) break;
        } while(checkCollision(x,y,boxWidth,boxHeight,placed));

        // salva posizione su Supabase
        fetch("/idea/position", {
          method:"POST",
          headers:{"Content-Type":"application/json"},
          body:JSON.stringify({id:idea.id,x,y})
        });
      }

      div.style.left = x + "px";
      div.style.top = y + "px";
      placed.push({x,y,width:div.offsetWidth,height:div.offsetHeight});
    }

    // Aggiorna solo dimensione font
    const size = 14 + (freq[phrase]-minFreq)/(maxFreq-minFreq||1)*40;
    div.style.fontSize = size + "px";
  }
}

loadIdeas();
setInterval(loadIdeas,5000);
</script>
</body>
</html>
